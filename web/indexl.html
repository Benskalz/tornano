<!DOCTYPE html>
<html>
<head>
  <title>Tornano App üå™Ô∏è</title>
  <link rel="icon" href="https://xno.nano.org/images/xno-badge-blue.png" type="image/png">
  <style>
    /* CSS styles for the form */
    body {
      font-family: Arial, sans-serif;
    }

    .container {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      border: 1px solid #ccc;
      border-radius: 5px;
      background-color: #f4f4f4;
    }

    .container h2 {
      text-align: center;
      margin-bottom: 20px;
    }

    .form-group {
      margin-bottom: 15px;
    }

    .form-group label {
      display: block;
      font-weight: bold;
    }

    .form-group input {
      width: 100%;
      padding: 5px;
      border: 1px solid #ccc;
      border-radius: 3px;
    }

    .form-group button {
      display: block;
      width: 100%;
      padding: 8px;
      border: none;
      border-radius: 3px;
      background-color: #4CAF50;
      color: #fff;
      font-weight: bold;
      cursor: pointer;
    }

    .qr-code {
      text-align: center;
      margin-top: 20px;
    }

    .qr-code img {
      max-width: 200px;
      height: auto;
    }

    .status-message {
      text-align: center;
      margin-top: 20px;
      font-weight: bold;
    }
  </style>
</head>
<body>
  <div class="container">
    <h2>Tornano API Interface</h2>
    <form id="tornanoForm">
      <div class="form-group">
        <label for="toAddress">To Address:</label>
        <input type="text" id="toAddress" name="toAddress" required>
      </div>
      <div class="form-group">
        <label for="cycles">Cycles:</label>
        <input type="number" id="cycles" name="cycles" required>
      </div>
      <div class="form-group">
        <label for="decalage">Decalage:</label>
        <input type="number" id="decalage" name="decalage" required>
      </div>
      <div class="form-group">
        <button type="submit">Submit</button>
      </div>
    </form>

    <div id="loading" style="display: none;">
        <div style="width:100%;height:0;padding-bottom:72%;position:relative;"><iframe src="https://giphy.com/embed/iJCo9daAP0xugHhhfb" width="100%" height="100%" style="position:absolute" frameBorder="0" class="giphy-embed" allowFullScreen></iframe></div>
      <p><a href="https://giphy.com/gifs/error-unreal-compile-iJCo9daAP0xugHhhfb">via GIPHY</a></p>
    </div>

    <div id="receptionAddress" class="qr-code" style="display: none;">
      <h3>Reception Address:</h3>
      <p id="address"></p>
      <img id="qrCode" src="" alt="QR Code">
    </div>

    <div id="success" style="display: none;">
        <div style="width:100%;height:0;padding-bottom:91%;position:relative;"><iframe src="https://giphy.com/embed/icOaTyR7FLSepWR9MW" width="100%" height="100%" style="position:absolute" frameBorder="0" class="giphy-embed" allowFullScreen></iframe></div>
      <p><a href="https://giphy.com/gifs/AlaynaJoy-secrets-missfenderr-alayna-joy-1laV2cmHAD0M5I5EYG">via GIPHY</a></p>
    </div>

    <div id="status" class="status-message" style="display: none;">
      <h3>Status:</h3>
      <p id="statusMessage"></p>
    </div>
  </div>

  <script>
    // JavaScript code for handling form submission
    document.getElementById('tornanoForm').addEventListener('submit', function(event) {
      event.preventDefault(); // Prevent form submission

      // Hide form and display loading gif
      document.getElementById('tornanoForm').style.display = 'none';
      document.getElementById('loading').style.display = 'block';

      // Get form values
      const toAddress = document.getElementById('toAddress').value;
      const cycles = document.getElementById('cycles').value;
      const decalage = document.getElementById('decalage').value;

      // Create request payload
      const payload = {
        to: toAddress,
        cycles: parseInt(cycles),
        decalage: parseInt(decalage)
      };

      // Send POST request to the Tornano API endpoint
      fetch('/create', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify(payload)
      })
      .then(response => response.json())
      .then(data => {
        // Hide loading gif and display reception address
        document.getElementById('loading').style.display = 'none';
        document.getElementById('address').textContent = data.deposit;
        document.getElementById('qrCode').src = 'https://api.qrserver.com/v1/create-qr-code/?data=' + data.deposit;
        document.getElementById('receptionAddress').style.display = 'block';

        // Start checking user status every 5 seconds
        setInterval(checkUserStatus, 5000);
      })
      .catch(error => {
        console.error(error);
        // Display error message
        document.getElementById('loading').style.display = 'none';
        document.getElementById('tornanoForm').style.display = 'block';
        document.getElementById('tornanoForm').reset();
        document.getElementById('statusMessage').innerHTML = '<strong>Error:</strong> An error occurred while creating the deposit.';
        document.getElementById('status').style.display = 'block';
      });
    });

    // Function to check user status
    function checkUserStatus() {
      const address = document.getElementById('address').textContent;
      fetch(`/users/${address}`)
        .then(response => response.json())
        .then(data => {
          console.log(data);
          if (data.status === 'true') {
            document.getElementById('statusMessage').textContent = 'User status: true';
            document.getElementById('success').style.display = 'block';
            document.getElementById('receptionAddress').style.display = 'none';
            clearInterval(checkUserStatus); // Stop checking user status
          } else {
            document.getElementById('statusMessage').textContent = 'User status: false';
          }
          document.getElementById('status').style.display = 'block';
        })
        .catch(error => {
          console.error(error);
          // TODO: Display error message
        });
    }
  </script>
</body>
</html>